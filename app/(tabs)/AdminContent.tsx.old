'use client';

import React, { useState, useEffect } from 'react';
import {
  View,
  Text,
  StyleSheet,
  ScrollView,
  TouchableOpacity,
  ActivityIndicator,
  Alert,
  TextInput,
  FlatList,
} from 'react-native';
import { SafeAreaView } from 'react-native-safe-area-context';
import { Ionicons } from '@expo/vector-icons';
import { Colors } from '@/constants/Colors';
import { useColorScheme } from '@/hooks/useColorScheme';
import { useAuth } from '@/contexts/AuthContext';
import { getSupabase } from '@/lib/supabase';

interface AdminStats {
  total_users: number;
  total_fragrances: number;
  active_listings: number;
  total_swaps: number;
  pending_swaps: number;
}

interface Fragrance {
  id: string;
  name: string;
  brand: string;
  concentration?: string;
  year_released?: number;
  data_quality_score: number;
  verified: boolean;
}

export default function AdminContent() {
  const { user } = useAuth();
  const colorScheme = useColorScheme();
  const colors = Colors[colorScheme];

  const [loading, setLoading] = useState(true);
  const [activeTab, setActiveTab] = useState('overview');
  const [stats, setStats] = useState<AdminStats | null>(null);
  const [fragrances, setFragrances] = useState<Fragrance[]>([]);
  const [searchQuery, setSearchQuery] = useState('');

  const supabase = getSupabase();

  useEffect(() => {
    loadAdminData();
  }, []);

  const loadAdminData = async () => {
    if (!supabase) return;

    try {
      setLoading(true);

      // Load stats
      const { data: users } = await supabase.from('users').select('id');
      const { data: fragranceData } = await supabase.from('fragrance_master').select('id');
      const { data: listings } = await supabase.from('listings').select('id').eq('is_active', true);
      const { data: swaps } = await supabase.from('swaps').select('id, status');

      setStats({
        total_users: users?.length || 0,
        total_fragrances: fragranceData?.length || 0,
        active_listings: listings?.length || 0,
        total_swaps: swaps?.length || 0,
        pending_swaps: swaps?.filter(s => s.status === 'proposed').length || 0,
      });

      // Load fragrance data for AI enhancement
      loadFragrances();
    } catch (error) {
      console.error('Error loading admin data:', error);
    } finally {
      setLoading(false);
    }
  };

  const loadFragrances = async () => {
    if (!supabase) return;

    try {
      let query = supabase
        .from('fragrance_master')
        .select('id, name, brand, concentration, year_released, data_quality_score, verified')
        .order('created_at', { ascending: false })
        .limit(50);

      if (searchQuery) {
        query = query.or(`name.ilike.%${searchQuery}%,brand.ilike.%${searchQuery}%`);
      }

      const { data, error } = await query;

      if (error) throw error;
      setFragrances(data || []);
    } catch (error) {
      console.error('Error loading fragrances:', error);
    }
  };

  const handleAIEnhancement = async (fragranceId: string) => {
    Alert.alert(
      'AI Enhancement',
      'This would start the AI enhancement workflow for this fragrance. The system will analyze and improve the fragrance data using your configured AI providers.',
      [
        { text: 'Cancel', style: 'cancel' },
        {
          text: 'Start Enhancement',
          onPress: async () => {
            // Here you would call your AI enhancement system
            Alert.alert('Success', 'AI enhancement started! You can monitor progress in the AI Enhancement tab.');
          }
        },
      ]
    );
  };

  useEffect(() => {
    if (searchQuery.length > 0 || searchQuery === '') {
      const delayedSearch = setTimeout(() => {
        loadFragrances();
      }, 300);
      return () => clearTimeout(delayedSearch);
    }
  }, [searchQuery]);

  if (loading) {
    return (
      <SafeAreaView style={[styles.container, { backgroundColor: colors.background }]}>
        <View style={styles.loadingContainer}>
          <ActivityIndicator size="large" color="#8B5CF6" />
          <Text style={[styles.loadingText, { color: colors.text }]}>Loading Admin Panel...</Text>
        </View>
      </SafeAreaView>
    );
  }

  if (!user?.is_admin) {
    return (
      <SafeAreaView style={[styles.container, { backgroundColor: colors.background }]}>
        <View style={styles.accessDenied}>
          <Ionicons name="lock-closed" size={64} color={colors.textSecondary} />
          <Text style={[styles.accessDeniedTitle, { color: colors.text }]}>Access Denied</Text>
          <Text style={[styles.accessDeniedText, { color: colors.textSecondary }]}>
            You don't have admin privileges to access this page.
          </Text>
        </View>
      </SafeAreaView>
    );
  }

  const createStyles = () => StyleSheet.create({
    container: {
      flex: 1,
    },
    loadingContainer: {
      flex: 1,
      justifyContent: 'center',
      alignItems: 'center',
    },
    loadingText: {
      marginTop: 16,
      fontSize: 16,
    },
    accessDenied: {
      flex: 1,
      justifyContent: 'center',
      alignItems: 'center',
      padding: 40,
    },
    accessDeniedTitle: {
      fontSize: 24,
      fontWeight: 'bold',
      marginTop: 16,
    },
    accessDeniedText: {
      fontSize: 16,
      textAlign: 'center',
      marginTop: 8,
    },
    header: {
      padding: 20,
      borderBottomWidth: 1,
    },
    headerTitle: {
      fontSize: 28,
      fontWeight: 'bold',
    },
    headerSubtitle: {
      fontSize: 14,
      marginTop: 4,
    },
    tabContainer: {
      flexDirection: 'row',
      paddingHorizontal: 20,
    },
    tab: {
      paddingVertical: 16,
      paddingHorizontal: 20,
      borderBottomWidth: 2,
      borderBottomColor: 'transparent',
    },
    activeTab: {
      borderBottomColor: '#8B5CF6',
    },
    tabText: {
      fontSize: 14,
      fontWeight: '600',
    },
    activeTabText: {
      color: '#8B5CF6',
    },
    content: {
      flex: 1,
      padding: 20,
    },
    statsGrid: {
      flexDirection: 'row',
      flexWrap: 'wrap',
      gap: 16,
    },
    statCard: {
      padding: 20,
      borderRadius: 12,
      flex: 1,
      minWidth: 150,
    },
    statValue: {
      fontSize: 32,
      fontWeight: 'bold',
      color: '#8B5CF6',
    },
    statLabel: {
      fontSize: 14,
      marginTop: 4,
    },
    searchContainer: {
      marginBottom: 20,
    },
    searchInput: {
      borderRadius: 8,
      padding: 12,
      fontSize: 16,
      borderWidth: 1,
    },
    fragranceCard: {
      padding: 16,
      marginBottom: 12,
      borderRadius: 12,
      borderWidth: 1,
    },
    fragranceHeader: {
      flexDirection: 'row',
      justifyContent: 'space-between',
      alignItems: 'flex-start',
      marginBottom: 8,
    },
    fragranceName: {
      fontSize: 18,
      fontWeight: 'bold',
      flex: 1,
    },
    fragranceBrand: {
      fontSize: 14,
      marginBottom: 4,
    },
    fragranceDetails: {
      flexDirection: 'row',
      justifyContent: 'space-between',
      alignItems: 'center',
      marginTop: 12,
    },
    qualityScore: {
      fontSize: 14,
      fontWeight: '600',
    },
    aiButton: {
      backgroundColor: '#8B5CF6',
      paddingVertical: 8,
      paddingHorizontal: 16,
      borderRadius: 6,
      flexDirection: 'row',
      alignItems: 'center',
      gap: 6,
    },
    aiButtonText: {
      color: '#FFFFFF',
      fontSize: 14,
      fontWeight: '600',
    },
  });

  const styles = createStyles();

  const renderOverview = () => (
    <View>
      <Text style={[styles.headerTitle, { color: colors.text, fontSize: 20, marginBottom: 20 }]}>
        System Overview
      </Text>
      <View style={styles.statsGrid}>
        <View style={styles.statCard}>
          <Text style={styles.statValue}>{stats?.total_users || 0}</Text>
          <Text style={styles.statLabel}>Total Users</Text>
        </View>
        <View style={styles.statCard}>
          <Text style={styles.statValue}>{stats?.total_fragrances || 0}</Text>
          <Text style={styles.statLabel}>Fragrances</Text>
        </View>
        <View style={styles.statCard}>
          <Text style={styles.statValue}>{stats?.active_listings || 0}</Text>
          <Text style={styles.statLabel}>Active Listings</Text>
        </View>
        <View style={styles.statCard}>
          <Text style={styles.statValue}>{stats?.total_swaps || 0}</Text>
          <Text style={styles.statLabel}>Total Swaps</Text>
        </View>
      </View>
    </View>
  );

  const renderDatabase = () => (
    <View>
      <Text style={[styles.headerTitle, { color: colors.text, fontSize: 20, marginBottom: 20 }]}>
        Fragrance Master Database
      </Text>

      <View style={styles.searchContainer}>
        <TextInput
          style={styles.searchInput}
          placeholder="Search fragrances by name or brand..."
          placeholderTextColor={colors.textSecondary}
          value={searchQuery}
          onChangeText={setSearchQuery}
        />
      </View>

      <FlatList
        data={fragrances}
        keyExtractor={(item) => item.id}
        renderItem={({ item }) => (
          <View style={styles.fragranceCard}>
            <View style={styles.fragranceHeader}>
              <View style={{ flex: 1 }}>
                <Text style={styles.fragranceName}>{item.name}</Text>
                <Text style={styles.fragranceBrand}>{item.brand}</Text>
                {item.concentration && (
                  <Text style={[styles.fragranceBrand, { fontSize: 12 }]}>
                    {item.concentration} • {item.year_released}
                  </Text>
                )}
              </View>
            </View>

            <View style={styles.fragranceDetails}>
              <View>
                <Text style={[styles.qualityScore, {
                  color: item.data_quality_score >= 80 ? '#10B981' :
                         item.data_quality_score >= 60 ? '#F59E0B' : '#EF4444'
                }]}>
                  Quality: {item.data_quality_score}%
                </Text>
                {item.verified && (
                  <Text style={{ color: '#10B981', fontSize: 12, marginTop: 2 }}>
                    ✓ Verified
                  </Text>
                )}
              </View>

              <TouchableOpacity
                style={styles.aiButton}
                onPress={() => handleAIEnhancement(item.id)}
              >
                <Ionicons name="sparkles" size={14} color="#FFFFFF" />
                <Text style={styles.aiButtonText}>Enhance</Text>
              </TouchableOpacity>
            </View>
          </View>
        )}
        showsVerticalScrollIndicator={false}
      />
    </View>
  );

  return (
    <SafeAreaView style={[styles.container, { backgroundColor: colors.background }]}>
      <View style={[styles.header, { borderBottomColor: colors.border }]}>
        <Text style={[styles.headerTitle, { color: colors.text }]}>Admin Dashboard</Text>
        <Text style={[styles.headerSubtitle, { color: colors.textSecondary }]}>
          Manage your ScentSwap platform • {stats?.total_fragrances} fragrances loaded
        </Text>
      </View>

      <View style={[styles.tabContainer, { backgroundColor: colors.card }]}>
        {[
          { id: 'overview', label: 'Overview' },
          { id: 'database', label: 'Database' },
        ].map((tab) => (
          <TouchableOpacity
            key={tab.id}
            style={[styles.tab, activeTab === tab.id && styles.activeTab]}
            onPress={() => setActiveTab(tab.id)}
          >
            <Text style={[styles.tabText, { color: activeTab === tab.id ? '#8B5CF6' : colors.textSecondary }]}>
              {tab.label}
            </Text>
          </TouchableOpacity>
        ))}
      </View>

      <ScrollView style={styles.content} showsVerticalScrollIndicator={false}>
        {activeTab === 'overview' && renderOverview()}
        {activeTab === 'database' && renderDatabase()}
      </ScrollView>
    </SafeAreaView>
  );
}