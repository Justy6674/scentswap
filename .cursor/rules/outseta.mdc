---
alwaysApply: true
---

# Outseta Integration Rules for ScentSwap

## ⚠️ CRITICAL: URL Configuration in Outseta Admin

### What Goes Where (Auth > Sign Up & Login)

| Setting | Value | Notes |
|---------|-------|-------|
| **Post Login URL** | `https://www.scentswap.com.au/` | Where users go AFTER login |
| **Post Sign Up URL** | **LEAVE EMPTY** | Outseta handles confirmation |
| **Sign Up Callback URL** | `https://www.scentswap.com.au/api/outseta/signup-callback` | Webhook for DB sync (Advanced Options) |

### Why No Custom Callback Page Needed

Outseta's **no-code approach** handles authentication automatically:
1. User logs in on Outseta's hosted page
2. Outseta redirects to Post Login URL (your app)
3. Outseta's embed script detects the session automatically
4. `SubscriptionContext` picks up via `Outseta.getUser()` and `Outseta.getJwtPayload()`

**DO NOT create a custom `/auth/callback` page to extract tokens. The Outseta script handles this.**

---

## Plan UIDs

| Plan | UID | Price |
|------|-----|-------|
| Free | `z9MP7yQ4` | $0 |
| Premium | `vW5RoJm4` | $9.99/month AUD |
| Elite | `aWxr2rQV` | $19.99/month AUD |

---

## Auth URLs (Direct Redirect)

```javascript
// Login
window.location.href = 'https://scentswap.outseta.com/auth?widgetMode=login#o-anonymous';

// Sign up (general)
window.location.href = 'https://scentswap.outseta.com/auth?widgetMode=register#o-anonymous';

// Sign up with plan pre-selected
window.location.href = 'https://scentswap.outseta.com/auth?widgetMode=register&planUid=vW5RoJm4#o-anonymous';

// Profile/Billing
window.location.href = 'https://scentswap.outseta.com/profile#o-authenticated';
```

---

## Embed Script Configuration

```javascript
var o_options = {
  domain: 'scentswap.outseta.com',
  load: 'auth,customForm,emailList,leadCapture,nocode,profile,support',
  tokenStorage: 'local',  // IMPORTANT: Persist across tabs/refreshes
  monitorDom: true        // For SPA navigation
};
```

---

## Approved Outseta Methods

Only use these client-side methods:

```javascript
// Get user info
const user = await Outseta.getUser();

// Get JWT payload
const payload = await Outseta.getJwtPayload();

// Set/clear token
Outseta.setAccessToken(token);
Outseta.setAccessToken(null); // Logout
```

**DO NOT USE:**
- `Outseta.auth.open()` - Use direct URL redirects instead
- `Outseta.profile.open()` - Use direct URL redirects instead
- Any undocumented methods

---

## Admin Authentication

Uses hardcoded email whitelist in `lib/admin.ts`:

```typescript
const ADMIN_EMAILS = ['downscale@icloud.com'];

export function isAdmin(email?: string | null): boolean {
  if (!email) return false;
  return ADMIN_EMAILS.includes(email.toLowerCase());
}
```

To add new admin: Edit `lib/admin.ts`, add email, deploy.

---

## Webhooks (Optional - for Supabase sync)

### Sign-Up Callback
- **URL:** `https://www.scentswap.com.au/api/outseta/signup-callback`
- **Purpose:** Create user in Supabase when they sign up in Outseta

### Subscription Updated
- **URL:** `https://www.scentswap.com.au/api/outseta/subscription-updated`
- **Purpose:** Sync plan changes to Supabase

### Signature Verification
Set webhook signing key in Outseta Settings > Notifications and verify with HMAC SHA256.

---

## Key Principles

1. **Outseta is the ONLY auth provider** - DO NOT use Supabase Auth
2. **Use no-code approach** - Direct URL redirects, not widget APIs
3. **Post Login URL = App page** - NOT an API endpoint
4. **Post Sign Up URL = EMPTY** - Let Outseta handle confirmation
5. **tokenStorage: "local"** - Persist sessions across tabs
6. **Store Outseta IDs in Supabase** - `outseta_person_uid`, `outseta_account_uid`
